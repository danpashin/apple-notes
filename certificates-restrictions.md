# Ограничения приложений, подписанных сторонними сертификатами


**Данная статья не относится к людям, имеющим доступ к аккаунту Apple**. В основном она про сервисы, занимающиеся продажей мест в этом аккаунте и выдающих так называемые "сертификаты"

## Вступление

Итак, вы купили сертификат, но обнаружили, что одна из привычных вам функций - например смена иконки - не работает. Что делать и кого винить? Вероятно вы подумали "плохой продавец", но нет. На самом деле, Apple.

## Что точно не будет работать?

- Изменение иконок внутри приложения
- Запуск фоновых задач (будь то refresh или background, без разницы)
- Корректная работа с файлами (одновременное открытие файла в нескольких приложениях, перемещение и тд)
- Переход к приложению, проигрывающему медиафайл, из центра управления
- Иное, что автор данной статьи не исследовал

## Почему?

Чтобы понять это, нам придётся углубиться в тонкости процесса подписи кода у всех систем Apple.

У нас есть:
1. Сам сертификат формата X.509
2. Цифровой ключ RSA с приватной его частью
3. Файл MobileProvision

И если с первыми двумя еще все более-менее понятно (да и так как их применение повсеместное, то можно найти информацию по ним на том же хабре), то с файлом .mobileprovison не все так просто.

### Что ты такое?

Файл .mobileprovision или же **файл подготовки цифровой подписи** - это прежде всего **подписанный** компанией Apple файл с данными, жизненно необходимыми для создания подписи файл, без него подпись не считается корректной. Так как он сам по себе подписан, то его изменение просто невозможно - при попытке его изменить, система сверит фактические данных и их хэш и найдет разницу. 

Этот файл содержит огромное количество нужной информации, в частности
- Entitlements - разрешения на доступ к разным API системы (и нет, это не те разрешения, что вы даете приложению в настройках)
- Application Identifier - уникальный идентификатор приложения
- PPQ - разрешение на использование подсистемы Provision Profile Query, но о нем как-нибудь в следующий раз

И нас интересует Application Identifier, ведь именно он является причиной наших бед. Я не ошибся, когда сказал про *уникальный*, ведь он действительно таким и является. Только вот... он уникален в другом плане. 

### Так в чём причина-то?

Дело в том, что система iOS - закрытая, а значит для получения каких-либо данных извне, приложение должно их откуда-то запросить. Делается это с помощью **демонов** (daemons), а взаимодействие с ними происходит через интерфейсы XPC - примитивы ядра. Так вот в любой системе Apple есть огромное-огромное-огромное количество других программ, которые приложениями в классическом их понимании не являются, а потому у них нет bundle identifier в противовес классическим приложениям. А значит для проверки клиента в XPC-сервере необходим какой-то другой идентификатор, чем application-identifier и является.

Но так как мы подписываем множество приложений с одним Application Identifier, а bundle identifier у них разные, то происходит несостыковка в данных при проверке клиента в XPC-сервере. От этого система не понимает, что мы хотим выполнить некое действие от **конкретного** приложения, а потому ломается и некая конкретная фича приложения.

## Есть возможность исправления?

К сожалению, нет. Необходимо подписывать **разные** приложения **разными** mobileprovision, что требует постоянного доступа к аккаунту разработчика. А значит в типичном случае покупки "сертификата" это невозможно просто по определению. Но зато всё это будет прекрасно работать в AltStore, Sideloadly и других программах подписи на 7 дней.

Вот и получается, что приложения на год ставить мы можем, но некоторая их функциональность все равно не работает. Костыли как они есть.